{% extends "tabs.html" %}

{% block content %}
<h1>Portfolio Dashboard</h1>
<div class="portfolio-summary">
    <div class="metric-card">
        <h3>Total Portfolio Value</h3>
        <p class="value">${{ '%.2f'|format(total_value) }}</p>
    </div>
    <div class="metric-card">
        <h3>Cash Balance</h3>
        <p class="value">${{ '%.2f'|format(cash_balance) }}</p>
    </div>
    <div class="metric-card">
        <h3>Invested Amount</h3>
        <p class="value">${{ '%.2f'|format(total_invested) }}</p>
    </div>
    <div class="metric-card {% if total_profit_loss >= 0 %}gain{% else %}loss{% endif %}">
        <h3>Total P&L</h3>
        <p class="value">${{ '%.2f'|format(total_profit_loss) }}</p>
        <p class="percentage">({{ '%.2f'|format(percentage_gain) }}%)</p>
    </div>
    <div class="metric-card {% if net_gain_loss >= 0 %}gain{% else %}loss{% endif %}">
        <h3>Net Gain/Loss</h3>
        <p class="value">${{ '%.2f'|format(net_gain_loss) }}</p>
        <p class="percentage">({{ '%.2f'|format(net_percentage_gain) }}%)</p>
        <p class="subtitle">on ${{ '%.0f'|format(initial_investment) }} initial</p>
    </div>
</div>

<!-- Manual Trigger Section -->
<div class="trigger-section">
    <h3>Manual System Triggers</h3>
    <p class="trigger-description">Use these buttons to manually trigger system components for testing:</p>
    <div class="trigger-buttons">
        <button class="trigger-btn" onclick="triggerAgent('summarizer')">
            <span class="btn-icon">ðŸ“°</span>
            Run Summarizer Agents
        </button>
        <button class="trigger-btn" onclick="triggerAgent('decider')">
            <span class="btn-icon">ðŸ¤–</span>
            Run Decider Agent
        </button>
        <button class="trigger-btn" onclick="triggerAgent('feedback')">
            <span class="btn-icon">ðŸ“Š</span>
            Run Feedback Agent
        </button>
        <button class="trigger-btn trigger-all" onclick="triggerAgent('all')">
            <span class="btn-icon">ðŸš€</span>
            Run All Agents
        </button>
    </div>
    <div id="trigger-status" class="trigger-status"></div>
</div>



<style>
.portfolio-summary {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}
.metric-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    min-width: 180px;
    text-align: center;
}
.metric-card h3 {
    margin: 0 0 10px 0;
    color: #495057;
    font-size: 14px;
    font-weight: 600;
}
.metric-card .value {
    margin: 0;
    font-size: 24px;
    font-weight: bold;
    color: #212529;
}
.metric-card .percentage {
    margin: 5px 0 0 0;
    font-size: 14px;
    font-weight: 600;
}
.metric-card .subtitle {
    margin: 2px 0 0 0;
    font-size: 11px;
    color: #6c757d;
    font-weight: normal;
}
.metric-card.gain .value, .metric-card.gain .percentage {
    color: #28a745;
}
.metric-card.loss .value, .metric-card.loss .percentage {
    color: #dc3545;
}
.gain { color: #28a745; }
.loss { color: #dc3545; }

/* Trigger Section Styles */
.trigger-section {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
}

.trigger-section h3 {
    margin: 0 0 10px 0;
    color: #495057;
    font-size: 18px;
    font-weight: 600;
}

.trigger-description {
    margin: 0 0 15px 0;
    color: #6c757d;
    font-size: 14px;
}

.trigger-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 15px;
}

.trigger-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 15px;
    border: 1px solid #007bff;
    border-radius: 6px;
    background: #007bff;
    color: white;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.trigger-btn:hover {
    background: #0056b3;
    border-color: #0056b3;
    transform: translateY(-1px);
}

.trigger-btn:active {
    transform: translateY(0);
}

.trigger-btn:disabled {
    background: #6c757d;
    border-color: #6c757d;
    cursor: not-allowed;
    transform: none;
}

.trigger-all {
    background: #28a745;
    border-color: #28a745;
}

.trigger-all:hover {
    background: #1e7e34;
    border-color: #1e7e34;
}

.btn-icon {
    font-size: 16px;
}

.trigger-status {
    padding: 10px;
    border-radius: 4px;
    font-size: 14px;
    min-height: 20px;
}

.trigger-status.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.trigger-status.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.trigger-status.loading {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

/* Reset Button Styles */
.reset-container {
    text-align: center;
    margin-top: 30px;
    margin-bottom: 20px;
}

.reset-btn-small {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border: 1px solid #dc3545;
    border-radius: 4px;
    background: #dc3545;
    color: white;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.reset-btn-small:hover {
    background: #c82333;
    border-color: #c82333;
    transform: translateY(-1px);
}

.reset-btn-small:active {
    transform: translateY(0);
}

.reset-btn-small:disabled {
    background: #6c757d;
    border-color: #6c757d;
    cursor: not-allowed;
    transform: none;
}

.reset-status-small {
    margin-top: 8px;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 12px;
    min-height: 16px;
    display: none;
}

.reset-status-small.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    display: block;
}

.reset-status-small.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    display: block;
}

.reset-status-small.loading {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
    display: block;
}
</style>

<table>
    <thead>
        <tr>
            <th>Ticker</th>
            <th>Shares</th>
            <th>Purchase Price</th>
            <th>Current Price</th>
            <th>Total Value</th>
            <th>Current Value</th>
            <th>Gain/Loss</th>
            <th>Reason</th>
        </tr>
    </thead>
    <tbody>
        {% for row in holdings %}
        <tr onclick="loadChart('{{ row.ticker }}')">
            <td>{{ row.ticker }}</td>
            <td>{{ row.shares }}</td>
            <td>{{ '%.2f'|format(row.purchase_price) }}</td>
            <td>{{ '%.2f'|format(row.current_price) }}</td>
            <td>{{ '%.2f'|format(row.total_value) }}</td>
            <td>{{ '%.2f'|format(row.current_value) }}</td>
            <td class="{{ 'gain' if row.gain_loss >= 0 else 'loss' }}">{{ '%.2f'|format(row.gain_loss) }}</td>
            <td>{{ row.reason }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="charts-container">
    <div class="chart-section">
        <h2 id="chart-title">Portfolio Value Over Time</h2>
        <canvas id="historyChart"></canvas>
    </div>
    <div class="chart-section">
        <h2>Net Performance vs Initial $10,000</h2>
        <canvas id="performanceChart"></canvas>
    </div>
    <div class="chart-section">
        <h2>Portfolio Breakdown</h2>
        <canvas id="breakdownChart"></canvas>
    </div>
</div>

<style>
.charts-container {
    display: flex;
    gap: 30px;
    margin-top: 30px;
    flex-wrap: wrap;
}
.chart-section {
    flex: 1;
    min-width: 400px;
}
.chart-section canvas {
    max-height: 400px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('historyChart').getContext('2d');
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    const breakdownCtx = document.getElementById('breakdownChart').getContext('2d');
    let chart;
    let performanceChart;
    let breakdownChart;

    function renderChart(data, label = 'Portfolio Value') {
        const labels = data.map(row => new Date(row.timestamp).toLocaleDateString());
        const values = data.map(row => row.total_portfolio_value);

        if (chart) chart.destroy();

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: values,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Portfolio Value ($)'
                        },
                        beginAtZero: false
                    }
                }
            }
        });
    }

    function renderPerformanceChart(data) {
        console.log('Rendering performance chart with data:', data);
        
        try {
            const labels = data.map(row => new Date(row.timestamp).toLocaleDateString());
            const netGainLoss = data.map(row => parseFloat(row.net_gain_loss) || 0);
            const netPercentageGain = data.map(row => parseFloat(row.net_percentage_gain) || 0);
            const portfolioValue = data.map(row => parseFloat(row.total_portfolio_value) || 0);
            
            console.log('Processed data:', { labels, netGainLoss, netPercentageGain, portfolioValue });

            if (performanceChart) performanceChart.destroy();

            // Reset canvas display
            const performanceCtx = document.getElementById('performanceChart');
            if (performanceCtx) {
                performanceCtx.style.display = 'block';
                performanceCtx.style.height = 'auto';
                performanceCtx.style.backgroundColor = 'transparent';
                performanceCtx.style.border = 'none';
                performanceCtx.style.borderRadius = '0';
                performanceCtx.innerHTML = '';
            }

            // Create a simpler chart with just the net gain/loss
            performanceChart = new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Net Gain/Loss ($)',
                        data: netGainLoss,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Net Gain/Loss ($)'
                            },
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error rendering performance chart:', error);
            // Show error message on the chart
            const performanceCtx = document.getElementById('performanceChart');
            if (performanceCtx) {
                performanceCtx.style.display = 'flex';
                performanceCtx.style.alignItems = 'center';
                performanceCtx.style.justifyContent = 'center';
                performanceCtx.style.height = '200px';
                performanceCtx.style.backgroundColor = '#f8d7da';
                performanceCtx.style.border = '1px solid #f5c6cb';
                performanceCtx.style.borderRadius = '4px';
                performanceCtx.innerHTML = '<div style="text-align: center; color: #721c24;"><p>Error rendering performance chart.</p><p>Please check console for details.</p></div>';
            }
        }
    }

    function renderBreakdownChart(data) {
        const labels = data.map(row => new Date(row.timestamp).toLocaleDateString());
        const cashBalance = data.map(row => row.cash_balance);
        const totalInvested = data.map(row => row.total_invested);

        if (breakdownChart) breakdownChart.destroy();

        breakdownChart = new Chart(breakdownCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Cash Balance',
                    data: cashBalance,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    fill: true,
                    tension: 0.1
                }, {
                    label: 'Invested Amount',
                    data: totalInvested,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Amount ($)'
                        }
                    }
                }
            }
        });
    }

    function loadChart(ticker = null) {
        if (ticker) {
            const url = `/api/history?ticker=${ticker}`;
            document.getElementById('chart-title').innerText = `History for ${ticker}`;
            fetch(url)
                .then(resp => resp.json())
                .then(data => renderChart(data, ticker))
                .catch(err => console.error('Failed to load chart:', err));
        } else {
            document.getElementById('chart-title').innerText = 'Portfolio Value Over Time';
            fetch('/api/portfolio-history')
                .then(resp => resp.json())
                .then(data => renderChart(data, 'Portfolio Value'))
                .catch(err => console.error('Failed to load chart:', err));
        }
    }

    function loadPerformanceChart() {
        console.log('Loading performance chart...');
        fetch('/api/portfolio-performance')
            .then(resp => resp.json())
            .then(data => {
                console.log('Performance data received:', data);
                if (data && data.length > 0) {
                    // Check if we have meaningful data (not all zeros)
                    const hasData = data.some(row => 
                        parseFloat(row.net_gain_loss) !== 0 || 
                        parseFloat(row.total_portfolio_value) !== 10000
                    );
                    
                    if (hasData) {
                        renderPerformanceChart(data);
                    } else {
                        console.log('No meaningful performance data available');
                        showNoDataMessage();
                    }
                } else {
                    console.log('No performance data available');
                    showNoDataMessage();
                }
            })
            .catch(err => {
                console.error('Failed to load performance chart:', err);
                showErrorMessage();
            });
    }

    function showNoDataMessage() {
        const performanceCtx = document.getElementById('performanceChart');
        if (performanceCtx) {
            performanceCtx.style.display = 'flex';
            performanceCtx.style.alignItems = 'center';
            performanceCtx.style.justifyContent = 'center';
            performanceCtx.style.height = '200px';
            performanceCtx.style.backgroundColor = '#f8f9fa';
            performanceCtx.style.border = '1px solid #dee2e6';
            performanceCtx.style.borderRadius = '4px';
            performanceCtx.innerHTML = '<div style="text-align: center; color: #6c757d;"><p>No performance data available yet.</p><p>Start trading to see performance metrics.</p></div>';
        }
    }

    function showErrorMessage() {
        const performanceCtx = document.getElementById('performanceChart');
        if (performanceCtx) {
            performanceCtx.style.display = 'flex';
            performanceCtx.style.alignItems = 'center';
            performanceCtx.style.justifyContent = 'center';
            performanceCtx.style.height = '200px';
            performanceCtx.style.backgroundColor = '#f8d7da';
            performanceCtx.style.border = '1px solid #f5c6cb';
            performanceCtx.style.borderRadius = '4px';
            performanceCtx.innerHTML = '<div style="text-align: center; color: #721c24;"><p>Error loading performance data.</p><p>Please try refreshing the page.</p></div>';
        }
    }

    function loadBreakdownChart() {
        fetch('/api/portfolio-history')
            .then(resp => resp.json())
            .then(data => renderBreakdownChart(data))
            .catch(err => console.error('Failed to load breakdown chart:', err));
    }

    function triggerAgent(agentType) {
        const statusDiv = document.getElementById('trigger-status');
        const buttons = document.querySelectorAll('.trigger-btn');
        
        // Show loading state
        statusDiv.innerHTML = `ðŸ”„ Triggering ${agentType} agent...`;
        statusDiv.className = 'trigger-status loading';
        
        // Disable all buttons
        buttons.forEach(btn => btn.disabled = true);
        
        // Make API call
        fetch(`/api/trigger/${agentType}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusDiv.innerHTML = `âœ… ${data.message}`;
                statusDiv.className = 'trigger-status success';
                
                // Refresh the page after a short delay to show updated data
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                statusDiv.innerHTML = `âŒ Error: ${data.error}`;
                statusDiv.className = 'trigger-status error';
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `âŒ Network error: ${error.message}`;
            statusDiv.className = 'trigger-status error';
        })
        .finally(() => {
            // Re-enable all buttons
            buttons.forEach(btn => btn.disabled = false);
        });
    }

    function resetPortfolio() {
        // Show confirmation dialog
        if (!confirm('Are you sure you want to reset the portfolio? This will:\n\nâ€¢ Sell all current holdings\nâ€¢ Reset cash balance to $10,000\nâ€¢ Clear all trading history\n\nThis action cannot be undone.')) {
            return;
        }
        
        const statusDiv = document.getElementById('reset-status');
        const button = document.querySelector('.reset-btn-small');
        
        // Show loading state
        statusDiv.innerHTML = 'ðŸ”„ Resetting portfolio...';
        statusDiv.className = 'reset-status-small loading';
        button.disabled = true;
        
        // Make API call
        fetch('/api/reset-portfolio', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusDiv.innerHTML = `âœ… ${data.message}`;
                statusDiv.className = 'reset-status-small success';
                
                // Refresh the page after a short delay to show updated data
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                statusDiv.innerHTML = `âŒ Error: ${data.error}`;
                statusDiv.className = 'reset-status-small error';
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `âŒ Network error: ${error.message}`;
            statusDiv.className = 'reset-status-small error';
        })
        .finally(() => {
            // Re-enable button
            button.disabled = false;
        });
    }

    window.onload = () => {
        loadChart();
        loadPerformanceChart();
        loadBreakdownChart();
    };

    function updatePrices() {
        const statusDiv = document.getElementById('price-update-status');
        const button = document.querySelector('.price-update-btn');
        
        // Show loading state
        statusDiv.innerHTML = 'ðŸ”„ Fetching latest stock prices...';
        statusDiv.className = 'price-update-status loading';
        button.disabled = true;
        
        // Make API call
        fetch('/api/trigger/price-update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusDiv.innerHTML = `âœ… ${data.message}`;
                statusDiv.className = 'price-update-status success';
                
                // Refresh the page after a short delay to show updated data
                setTimeout(() => {
                    location.reload();
                }, 3000);
            } else {
                statusDiv.innerHTML = `âŒ Error: ${data.error}`;
                statusDiv.className = 'price-update-status error';
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `âŒ Network error: ${error.message}`;
            statusDiv.className = 'price-update-status error';
        })
        .finally(() => {
            // Re-enable button
            button.disabled = false;
        });
    }
</script>

<!-- Price Update Button -->
<div class="price-update-container">
    <button class="price-update-btn" onclick="updatePrices()">
        <span class="btn-icon">ðŸ“ˆ</span>
        Update Stock Prices
    </button>
    <div id="price-update-status" class="price-update-status"></div>
</div>

<!-- Reset Portfolio Button -->
<div class="reset-container">
    <button class="reset-btn-small" onclick="resetPortfolio()">
        <span class="btn-icon">ðŸ”„</span>
        Reset Portfolio
    </button>
    <div id="reset-status" class="reset-status-small"></div>
</div>
{% endblock %}
